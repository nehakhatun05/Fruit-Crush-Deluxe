<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Neha Fruit Crush â€” Game</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #ff6ec4 0%, #7873f5 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; color: #fff; padding: 20px; overflow-x: hidden; }
    .container { width: 100%; max-width: 1200px; display: flex; flex-direction: column; gap: 30px; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 20px; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .logo { font-size: 2.0rem; font-weight: 800; background: linear-gradient(45deg, #ff9a9e, #fad0c4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 10px; }
    .header-actions { display: flex; gap: 10px; }
    .main-content { display: grid; grid-template-columns: 1fr 350px; gap: 30px; }
    .game-section { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .game-board { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; margin-bottom: 25px; position: relative; }
    .cell { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
    .cell:hover { transform: scale(1.05); background: rgba(255,255,255,0.15); }
    .cell.selected { transform: scale(1.1); box-shadow: 0 0 0 3px #fff, 0 0 15px 5px #ff7b00; z-index: 10; }
    .fruit { font-size: 32px; transition: all 0.3s ease; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); transform-style: preserve-3d; animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%,100%{ transform: translateY(0) rotateY(0);} 50%{ transform: translateY(-10px) rotateY(10deg);} }
    .bomb { font-size: 28px; animation: pulse 1s infinite, float 3s ease-in-out infinite; }
    @keyframes pulse { 0%{ transform: scale(1);} 50%{ transform: scale(1.2);} 100%{ transform: scale(1);} }
    .stats-section { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 25px; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 20px; }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .stat-box { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 15px; text-align: center; }
    .stat-value { font-size: 1.8rem; font-weight: bold; margin-top: 5px; color: #ffdd59; }
    .controls { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
    button { padding: 15px; border: none; border-radius: 15px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 10px; }
    button:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
    button:active { transform: translateY(1px); }
    .btn-primary { background: linear-gradient(45deg, #ff9a9e, #fad0c4); color: #333; }
    .btn-secondary { background: linear-gradient(45deg, #a18cd1, #fbc2eb); color: white; }
    .btn-danger { background: linear-gradient(45deg, #ff7b00, #ffcc00); color: white; }
    .score-popup { position: absolute; font-weight: bold; color: #ffdd59; font-size: 1.2rem; pointer-events: none; z-index: 20; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); animation: scoreFloat 1s ease forwards; }
    @keyframes scoreFloat { 0%{ transform: translateY(0); opacity: 1;} 100%{ transform: translateY(-50px); opacity: 0;} }
    .bomb-explosion { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle, #ff8800 0%, #ff5500 70%, transparent 71%); z-index: 15; animation: explode 0.5s ease-out forwards; }
    @keyframes explode { 0%{ transform: scale(0); opacity: 1;} 100%{ transform: scale(3); opacity: 0;} }
    .match-animation { animation: match 0.5s ease-out; }
    @keyframes match { 0%{ transform: scale(1);} 50%{ transform: scale(1.2);} 100%{ transform: scale(1);} }
    .swapping { animation: swap 0.3s ease; }
    @keyframes swap { 0%{ transform: scale(1);} 50%{ transform: scale(0.8);} 100%{ transform: scale(1);} }
    .game-over { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(10px); }
    .game-over-content { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); padding: 40px; border-radius: 20px; text-align: center; max-width: 500px; width: 90%; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
    .game-over h2 { font-size: 2.5rem; margin-bottom: 20px; color: #ff7b00; }
    @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } header { flex-direction: column; gap: 20px; text-align: center; } }
    @media (max-width: 600px) { .cell { width: 40px; height: 40px; } .fruit { font-size: 24px; } .stats-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <!-- Background Music and SFX -->
  <audio id="bgm" loop preload="auto" playsinline>
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_4f2d2b5f9a.mp3?filename=lofi-study-112191.mp3" type="audio/mpeg">
    <source src="assets/music/game-bgm.mp3" type="audio/mpeg">
    <source src="assets/music/game-bgm.ogg" type="audio/ogg">
  </audio>
  <audio id="selectSfx" preload="auto">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_6c7bf9f5f9.mp3?filename=click-124467.mp3" type="audio/mpeg">
    <source src="assets/sfx/select.mp3" type="audio/mpeg">
    <source src="assets/sfx/select.ogg" type="audio/ogg">
  </audio>

  <div class="container">
    <header>
      <div class="logo"><i class="fas fa-apple-alt"></i><span> Neha Fruit Crush</span></div>
      <div class="header-actions">
        <button class="btn-secondary" id="musicBtn"><i class="fas fa-music"></i> Music: On</button>
        <button class="btn-danger" id="menuBtn"><i class="fas fa-bars"></i> Level Menu</button>
      </div>
    </header>

    <div class="main-content">
      <div class="game-section">
        <h2>Current Level: <span id="currentLevel">1</span></h2>
        <div class="game-board" id="board"></div>
        <div class="controls">
          <button class="btn-primary" id="resetBtn"><i class="fas fa-redo"></i> Restart Level</button>
          <button class="btn-secondary" id="hintBtn"><i class="fas fa-lightbulb"></i> Get Hint (5)</button>
        </div>
      </div>

      <div class="stats-section">
        <div class="stats-grid">
          <div class="stat-box"><div class="stat-label">Score</div><div class="stat-value" id="score">0</div></div>
          <div class="stat-box"><div class="stat-label">Moves</div><div class="stat-value" id="moves">0</div></div>
          <div class="stat-box"><div class="stat-label">Time</div><div class="stat-value" id="time">60</div></div>
          <div class="stat-box"><div class="stat-label">Target Score</div><div class="stat-value">1000</div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="game-over" id="gameOver" style="display:none;">
    <div class="game-over-content">
      <h2>Level Complete!</h2>
      <p>You completed level <span id="completedLevel">1</span></p>
      <div class="score">+<span id="finalScore">0</span> points</div>
      <p>Moves: <span id="finalMoves">0</span> | Time: <span id="finalTime">0</span>s</p>
      <div class="controls" style="margin-top: 30px;">
        <button class="btn-primary" id="nextLevelBtn"><i class="fas fa-arrow-right"></i> Next Level</button>
        <button class="btn-danger" id="menuBtn2"><i class="fas fa-bars"></i> Level Menu</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Read level from URL (default 1)
      const params = new URLSearchParams(location.search);
      const startLevel = parseInt(params.get('level') || '1', 10);

      // Game configuration
      const COLS = 8; const ROWS = 8; const TYPES = 5; const START_TIME = 60; const MAX_LEVEL = 50;

      // DOM elements
      const boardEl = document.getElementById('board');
      const scoreEl = document.getElementById('score');
      const movesEl = document.getElementById('moves');
      const timeEl = document.getElementById('time');
      const currentLevelEl = document.getElementById('currentLevel');
      const resetBtn = document.getElementById('resetBtn');
      const hintBtn = document.getElementById('hintBtn');
      const gameOverEl = document.getElementById('gameOver');
      const finalScoreEl = document.getElementById('finalScore');
      const finalMovesEl = document.getElementById('finalMoves');
      const finalTimeEl = document.getElementById('finalTime');
      const completedLevelEl = document.getElementById('completedLevel');
      const nextLevelBtn = document.getElementById('nextLevelBtn');
      const menuBtn = document.getElementById('menuBtn');
      const menuBtn2 = document.getElementById('menuBtn2');
      const musicBtn = document.getElementById('musicBtn');

      // Audio initialization and handling
      const bgm = document.getElementById('bgm');
      const selectSfx = document.getElementById('selectSfx');
      let musicOn = true;
      bgm.volume = 0.4;
      selectSfx.volume = 0.6;
      
      // Audio error handling
      const initializeAudio = () => {
        bgm.addEventListener('error', (e) => {
          console.error('BGM loading error:', e);
          musicBtn.disabled = true;
          musicBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Audio Error';
          musicBtn.style.opacity = '0.6';
        });
        
        selectSfx.addEventListener('error', (e) => {
          console.error('SFX loading error:', e);
        });
        
        bgm.addEventListener('canplaythrough', () => {
          console.log('BGM loaded successfully');
        });
      };

      // Try to start music with better error handling
      const tryPlay = () => {
        if (musicOn) {
          bgm.play().catch(error => {
            console.warn('Autoplay blocked:', error);
            // Show user that interaction is needed
            musicBtn.innerHTML = '<i class="fas fa-play"></i> Click to Play';
          });
        }
      };
      
      // Multiple interaction listeners for better compatibility
      tryPlay();
      document.addEventListener('pointerdown', tryPlay, { once: true });
      document.addEventListener('click', tryPlay, { once: true });
      document.addEventListener('keydown', tryPlay, { once: true });

      musicBtn.addEventListener('click', () => {
        if (musicBtn.disabled) return;
        
        musicOn = !musicOn;
        if (musicOn) {
          bgm.play().catch(error => {
            console.warn('Play failed:', error);
            musicOn = false;
          });
          musicBtn.innerHTML = '<i class="fas fa-music"></i> Music: On';
        } else {
          bgm.pause();
          musicBtn.innerHTML = '<i class="fas fa-volume-mute"></i> Music: Off';
        }
      });

      // Initialize audio on load
      initializeAudio();

      // Game state
      let grid = []; let score = 0; let moves = 0; let level = isNaN(startLevel) ? 1 : startLevel; let isProcessing = false; let selectedCell = null; let timeLeft = START_TIME; let timer; let hintTimeout; let hintsLeft = 5;

      const fruits = ['\uD83C\uDF4E','\uD83C\uDF4C','\uD83C\uDF47','\uD83C\uDF4A','\uD83C\uDF53'];
      const fruitColors = ['#ff6b6b','#ffe066','#a29bfe','#ff9f43','#ff6b81'];

      function init() {
        clearInterval(timer); if (hintTimeout) clearTimeout(hintTimeout);
        grid = []; score = 0; moves = 0; isProcessing = false; selectedCell = null; timeLeft = START_TIME;
        updateHUD(); gameOverEl.style.display = 'none'; currentLevelEl.textContent = level;
        boardEl.innerHTML = '';
        for (let r=0;r<ROWS;r++){ const row=[]; for (let c=0;c<COLS;c++){ const cell=document.createElement('div'); cell.className='cell'; cell.dataset.r=r; cell.dataset.c=c; const fruit=document.createElement('div'); fruit.className='fruit'; cell.appendChild(fruit); boardEl.appendChild(cell); row.push({ r,c, el:cell, fruitEl:fruit, type:null, isBomb:false }); cell.addEventListener('click',()=>onCellClick(r,c)); } grid.push(row);}        
        fillBoard();
        timer = setInterval(()=>{ timeLeft--; updateHUD(); if (timeLeft<=0){ clearInterval(timer); endGame(); } }, 1000);
      }

      function setType(r,c,type,isBomb=false){ const cell=grid[r][c]; cell.type=type; cell.isBomb=isBomb; if (isBomb){ cell.fruitEl.textContent='\uD83D\uDCA3'; cell.fruitEl.className='fruit bomb'; } else if (type===null){ cell.fruitEl.textContent=''; cell.fruitEl.className='fruit'; cell.fruitEl.style.color='inherit'; } else { cell.fruitEl.textContent=fruits[type]; cell.fruitEl.className='fruit'; cell.fruitEl.style.color=fruitColors[type]; } }

      function getRandomType(r,c){ let type; let attempts=0; do { type=Math.floor(Math.random()*TYPES); attempts++; if (attempts>100) return type; } while (createsInitialMatch(r,c,type)); return type; }

      function createsInitialMatch(r,c,type){ if (c>=2 && grid[r][c-1].type===type && grid[r][c-2].type===type) return true; if (r>=2 && grid[r-1][c].type===type && grid[r-2][c].type===type) return true; return false; }

      function resolveInitialMatches(){ const matches=findMatches(); if (matches.length>0){ matches.forEach(m=> setType(m.r,m.c, Math.floor(Math.random()*TYPES))); resolveInitialMatches(); } }

      function fillBoard(){ for (let r=0;r<ROWS;r++){ for (let c=0;c<COLS;c++){ setType(r,c,getRandomType(r,c)); } } resolveInitialMatches(); }

      function updateHUD(){ scoreEl.textContent=score; movesEl.textContent=moves; timeEl.textContent=timeLeft; updateHintButton(); }

      function onCellClick(r,c){ if (isProcessing || timeLeft<=0) return; const cell=grid[r][c]; try { selectSfx.currentTime=0; selectSfx.play(); } catch(e){}
        if (!selectedCell){ selectedCell=cell; cell.el.classList.add('selected'); return; }
        if (selectedCell===cell){ selectedCell.el.classList.remove('selected'); selectedCell=null; return; }
        const dr=Math.abs(selectedCell.r-r); const dc=Math.abs(selectedCell.c-c);
        if ((dr===1&&dc===0)||(dr===0&&dc===1)){ swapCells(selectedCell, cell); } else { selectedCell.el.classList.remove('selected'); selectedCell=cell; cell.el.classList.add('selected'); }
      }

      async function swapCells(cell1,cell2){ isProcessing=true; cell1.el.classList.remove('selected'); selectedCell=null; cell1.el.classList.add('swapping'); cell2.el.classList.add('swapping');
        const t1=cell1.type, b1=cell1.isBomb; setType(cell1.r,cell1.c,cell2.type,cell2.isBomb); setType(cell2.r,cell2.c,t1,b1); await wait(300); cell1.el.classList.remove('swapping'); cell2.el.classList.remove('swapping');
        const matches=findMatches(); if (matches.length>0){ moves++; updateHUD(); await resolveMatches(matches); if (score>=1000){ clearInterval(timer); showLevelComplete(); } } else { setType(cell2.r,cell2.c,cell1.type,cell1.isBomb); setType(cell1.r,cell1.c,t1,b1); }
        isProcessing=false; }

      function findMatches(){ const matches=[]; for (let r=0;r<ROWS;r++){ for (let c=0;c<COLS-2;c++){ const type=grid[r][c].type; if (type!==null && type===grid[r][c+1].type && type===grid[r][c+2].type){ let len=3; while (c+len<COLS && grid[r][c+len].type===type) len++; for (let i=0;i<len;i++) matches.push({r, c:c+i}); c+=len-1; } } } for (let c=0;c<COLS;c++){ for (let r=0;r<ROWS-2;r++){ const type=grid[r][c].type; if (type!==null && type===grid[r+1][c].type && type===grid[r+2][c].type){ let len=3; while (r+len<ROWS && grid[r+len][c].type===type) len++; for (let i=0;i<len;i++) matches.push({r:r+i, c}); r+=len-1; } } } return matches; }

      async function resolveMatches(matches){ if (matches.length===0) return; const horizontal=[]; const vertical=[]; for (let r=0;r<ROWS;r++){ let start=-1,len=0; for (let c=0;c<COLS;c++){ const isM = matches.some(m=>m.r===r && m.c===c); if (isM){ if (start===-1) start=c; len++; } if (!isM || c===COLS-1){ if (len>=4) horizontal.push({r,c:start,length:len}); start=-1; len=0; } } } for (let c=0;c<COLS;c++){ let start=-1,len=0; for (let r=0;r<ROWS;r++){ const isM = matches.some(m=>m.r===r && m.c===c); if (isM){ if (start===-1) start=r; len++; } if (!isM || r===ROWS-1){ if (len>=4) vertical.push({c,r:start,length:len}); start=-1; len=0; } } }
        if (horizontal.length>0){ const m=horizontal[0]; const mid=m.c + Math.floor(m.length/2); setType(m.r, mid, grid[m.r][mid].type, true); } else if (vertical.length>0){ const m=vertical[0]; const mid=m.r + Math.floor(m.length/2); setType(mid, m.c, grid[mid][m.c].type, true); }
        matches.forEach(m=> grid[m.r][m.c].fruitEl.classList.add('match-animation'));
        await wait(500);
        matches.forEach(m=>{ const cell=grid[m.r][m.c]; cell.fruitEl.classList.remove('match-animation'); if (cell.isBomb){ const explosion=document.createElement('div'); explosion.className='bomb-explosion'; cell.el.appendChild(explosion); setTimeout(()=>{ cell.el.removeChild(explosion); }, 500); for (let rr=Math.max(0,m.r-1); rr<=Math.min(ROWS-1,m.r+1); rr++){ for (let cc=Math.max(0,m.c-1); cc<=Math.min(COLS-1,m.c+1); cc++){ if (grid[rr][cc].type !== null){ setType(rr,cc,null); } } } } else { setType(m.r,m.c,null); } });
        const points = matches.length*10; score += points; updateHUD(); showScorePopup(matches[0].r, matches[0].c, points); await applyGravity(); await refillBoard(); const newMatches=findMatches(); if (newMatches.length>0) await resolveMatches(newMatches);
      }

      async function applyGravity(){ for (let c=0;c<COLS;c++){ let empty=0; for (let r=ROWS-1;r>=0;r--){ if (grid[r][c].type===null){ empty++; } else if (empty>0){ const tr=r+empty; setType(tr,c,grid[r][c].type,grid[r][c].isBomb); setType(r,c,null); } } } await wait(500); }

      async function refillBoard(){ for (let c=0;c<COLS;c++){ for (let r=0;r<ROWS;r++){ if (grid[r][c].type===null){ setType(r,c, Math.floor(Math.random()*TYPES)); } } } await wait(300); }

      function showScorePopup(r,c,points){ const popup=document.createElement('div'); popup.className='score-popup'; popup.textContent = `+${points}`; popup.style.top = `${r*66+30}px`; popup.style.left = `${c*66+30}px`; boardEl.appendChild(popup); setTimeout(()=>{ if (popup.parentNode===boardEl) boardEl.removeChild(popup); }, 1000); }

      // Hint helpers
      function showHint(){ if (isProcessing || timeLeft<=0 || hintsLeft<=0) return; let found=false; outer: for (let r=0;r<ROWS;r++){ for (let c=0;c<COLS;c++){ if (c<COLS-1 && isValidSwap(grid[r][c], grid[r][c+1])){ highlightCells([grid[r][c], grid[r][c+1]]); found=true; break outer; } if (r<ROWS-1 && isValidSwap(grid[r][c], grid[r+1][c])){ highlightCells([grid[r][c], grid[r+1][c]]); found=true; break outer; } } } if (found){ hintsLeft--; updateHintButton(); } }
      function isValidSwap(a,b){ const t1=a.type,b1=a.isBomb,t2=b.type,b2=b.isBomb; setType(a.r,a.c,t2,b2); setType(b.r,b.c,t1,b1); const ok=findMatches().length>0; setType(a.r,a.c,t1,b1); setType(b.r,b.c,t2,b2); return ok; }
      function highlightCells(cells){ cells.forEach(c=>c.el.classList.add('selected')); if (hintTimeout) clearTimeout(hintTimeout); hintTimeout=setTimeout(()=>{ cells.forEach(c=>c.el.classList.remove('selected')); }, 1000); }
      function updateHintButton(){ hintBtn.innerHTML = `<i class="fas fa-lightbulb"></i> Get Hint (${hintsLeft})`; hintBtn.disabled = isProcessing || timeLeft<=0 || hintsLeft<=0; }

      // Utils
      const wait = (ms) => new Promise(res=>setTimeout(res, ms));
      function endGame(){ isProcessing=true; finalScoreEl.textContent=score; finalMovesEl.textContent=moves; finalTimeEl.textContent=0; completedLevelEl.textContent=level; const titleEl=gameOverEl.querySelector('h2'); if (titleEl) titleEl.textContent = "Time's Up!"; gameOverEl.style.display='flex'; }
      function showLevelComplete(){ finalScoreEl.textContent=score; finalMovesEl.textContent=moves; finalTimeEl.textContent=timeLeft; completedLevelEl.textContent=level; const titleEl=gameOverEl.querySelector('h2'); if (titleEl) titleEl.textContent='Level Complete!'; gameOverEl.style.display='flex'; try { const prev = parseInt(localStorage.getItem('unlockedLevel')||'1',10); localStorage.setItem('unlockedLevel', String(Math.max(prev, level+1))); } catch(e){} }

      // Controls
      resetBtn.addEventListener('click', ()=>{ hintsLeft=5; init(); });
      hintBtn.addEventListener('click', showHint);
      nextLevelBtn.addEventListener('click', ()=>{ gameOverEl.style.display='none'; level = Math.min(MAX_LEVEL, level+1); hintsLeft=5; init(); });
      menuBtn.addEventListener('click', ()=>{ location.href = 'index.html'; });
      menuBtn2.addEventListener('click', ()=>{ location.href = 'index.html'; });

      // Start
      init();
    });
  </script>
</body>
</html>